#!/usr/bin/env python3
import glob
import os
import stat
import sys

print('Warning: This script may need to be run with admin privilges')

# checking if ouput location was specified if not using /usr/local/bin
try:
    bin_dir = sys.argv[1]
except IndexError:
    print('Error: An output path must be provided')
    sys.exit(1)

if not os.path.isdir(bin_dir):
    print('Error: Specified path does not exist ' + os.path.abspath(bin_dir))
    sys.exit(1)

# checking if it was run as sudo
uid = int(os.environ.get('SUDO_UID'))
gid = int(os.environ.get('SUDO_GID'))
if uid is not None:
    sudo = True

# changing from cwd to the scripts directory
main_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
os.chdir(os.path.join(main_dir, 'scripts'))

# grabbing all scripts prefixed with 'apm_'
script_files = glob.glob('apm_*')

# looping over script files to create a runner for each one
content = '#!/bin/bash\npython3 {} $@\n'
for script in script_files:
    runner = os.path.basename(script)
    runner = os.path.splitext(runner)[0]
    runner = os.path.join(bin_dir, runner)
    #
    print('Creating runner for script ' + script)
    with open(runner, 'w') as f:
        f.write(content.format(os.path.abspath(script)))
    #
    # changing ownership if need be and making executable
    if sudo:
        os.chown(runner, uid, gid)
    perms = os.stat(runner)
    os.chmod(runner, perms.st_mode | stat.S_IXUSR | stat.S_IXGRP)

print('Add all scripts to: ' + bin_dir)

#DIR="$(pwd)"
#for script in $DIR/scripts/apm_*; do
#
#    # pulling out filename from path, runner needs no extension
#    runner=${script##*/}
#    runner=${runner%.*}
#    file=$(python -c 'import os; print(os.path.abspath("./scripts/apm_bulk_run.py"), end="")')
#
#    # creating runner file and setting as executable
#    echo "Creating runner for script $runner.py"
#    touch ~/bin/"$runner"
#    chmod ug+x ~/bin/"$runner"
#
#    # echoing content into file
#    echo "#!/bin/bash" > ~/bin/"$runner"
#    echo "python3 \"$file\" "\$@"" >> ~/bin/"$runner"
#done
#
#echo "Added all scripts to "~/"bin"
