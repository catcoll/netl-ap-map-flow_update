#!/bin/bash

# check if output directory provided otherwise use default
out_dir=~/.local/bin/
if [ ! -z $1 ]; then
    out_dir="$1"
fi

# check directory for trailing forward slash and append if needed
i=$((${#out_dir}-1))
if [ ! ${out_dir:$i:1} == '/' ]; then
    out_dir="$out_dir/"
fi

# check if directory exists
if [ ! -d "$out_dir" ]; then
    echo "Error directory does not exist: $out_dir"
    exit 1
fi

# Determining top level of repository
REPO_HOME=""
if command -v git >/dev/null 2>&1;  then
    echo "Using git to determine repository path"
    REPO_HOME=$(git rev-parse --show-toplevel)
fi
if [ ! $REPO_HOME ]; then
    echo ""
    echo "Defaulting to assume scripts are located at ./scripts"
    REPO_HOME=$(pwd)
fi
set -e

# looping over all scritps with apm_ prefix
cd $REPO_HOME
for script in ./scripts/apm_*; do

    # pulling out filename from path, runner needs no extension
    runner=${script##*/}
    runner=${runner%.*}

    # using python allows proper resolution of Cygwin and regular paths
    file=$(python -c "import os, sys; sys.stdout.write(os.path.abspath('$script'))")

    # creating runner file and setting as executable
    echo "Creating runner for script $runner.py"
    echo touch "$out_dir$runner"
    echo chmod ug+x "$out_dir$runner"

    # echoing content into file
    #echo "#!/bin/bash" > "$out_dir$runner"
    #echo "python3 \"$file\" "\$@"" >> "$out_dir$runner"
done

echo "Added all scripts to "$out_dir
