      PROGRAM APERTURE_MAP_FLOW
C
C     WRITTEN BY: MATTHEW STADELMAN
C
C     PROGRAM DESCRIPTON: RUNS THE LOCAL CUBIC LAW MODEL ON A SUPPLIED
C         FRACTURE APERTURE MAP OUTPUTTING THE DATA TO MULTIPLE CSV FILES
C         AND A VTK FILE FOR USE WITH PARAVIEW. THIS PROGRAM WAS DESIGNED
C         UNDER AN ORISE APPOINTMENT AT THE NATIONAL ENERGY TECHNOLOGY LAB
C         IN MORGANTOWN WEST VIRGINIA.
C
C     DATE WRITTEN:  2016/02/12
C     LAST MODIFIED: 2016/03/07
C
C     SUBROUTINE CALLS: INITIALIZE_RUN, FRAC_FLOW, PS_TO_PR,
C                       OUTPUT_DATA
C
C ---------------------------------------------------------------------
C     VARIABLE DESCRIPTION:
C       Q(1:4,:) - FLOW THROUGH THE SIDES OF A CELL IN ORDER: LEFT,RIGHT,TOP,BOTTOM
C       Q(5,:) - STORES THE FINAL NET MASS GAIN/LOSS FOR A CELL
C       FLOW - TOTAL FLOW OUT OF THE FRACTURE
C       HOM_TRANS - AVERAGE FRACTURE TRANSMISSIBILITY
C       BOK - CONTROL VARIABLE USED TO HALT PROGRAM IF A FATAL ERROR IS ENCOUNTERED
C
C ----------------------------------------------------------------------
C
      USE APM_MODULE
C
      IMPLICIT NONE
      REAL(8) :: FLOW
      INTEGER :: I,IC,IX,IZ
      LOGICAL :: BOK
C
C     CONDITIONAL COMPILATION TO DETERMINE OS
      SYS_OS = "UNIX"
      IF (WIN64 == 1) THEN
        SYS_OS = "WINDOWS"
      ENDIF
C
C     INITIALIZING THE MODEL
      BOK   = .TRUE.
      CALL INITIALIZE_RUN(BOK)
      IF (.NOT. BOK) GOTO 1000
C
C     RUNNING SUBROUTINE TO SOLVE FOR FLOW
      CALL BLANK
      CALL MESSAGE(" CALCULATING FLOW THROUGH FRACTURE")
c==============================================================================
c       IF (RATEC) THEN
c         CALL FRAC_FLOW(BOK)
c         IF (.NOT. BOK) GOTO 1000
c         CALL BLANK
c         CALL MESSAGE("     INTERMEDIATE FRACTURE FLOWS CALCULATED")
c C
c C       CALCULATING INTERMEDIATE VALUES TO CORRECT BOUNDARY PRESSURE
c C       FOR INHOMOGENEOUS APERTURE
c         CALL BLANK
c         WRITE(CVAR,600)"INTERMEDIATE",OUTPB*PRES_CONV,TRIM(UNIT_OUT(1))
c         CALL MESSAGE(CVAR)
c C
c         FLOW = 0.0
c         DO IC = 1,NC
c           I = OUTLET(IC)
c           IF (INDEX(OUTFLOW,'LEFT') > 0)   FLOW = FLOW + Q(1,I)
c           IF (INDEX(OUTFLOW,'RIGHT') > 0)  FLOW = FLOW + Q(2,I)
c           IF (INDEX(OUTFLOW,'BOTTOM') > 0) FLOW = FLOW + Q(3,I)
c           IF (INDEX(OUTFLOW,'TOP') > 0)    FLOW = FLOW + Q(4,I)
c         END DO
c         FLOW = ABS(FLOW)
c         WRITE(CVAR,605)"INTERMEDIATE",FLOW*RATE_CONV*STD_CONV,
c      &                               TRIM(UNIT_OUT(5))
c         CALL MESSAGE(CVAR)
c C
c C       SETTING UP SECOND RUN
c         FRAC_PS(:,:) = FPSB
c         !
c         ! ADJUSTING PRESSURE BOUNDARY
c         IF (INDEX(OUTFLOW,'LEFT') > 0) THEN
c           FLOW_CF = ABS(FLOW/(FPSB-OUTPSB)/AVG_TRX)
c           OUTRATE = OUTRATE/FLOW_CF
c           OUTPSB = FPSB - OUTRATE/AVG_TRX
c           DO IZ = 1,NZ
c             FRAC_PS(IZ,0) = OUTPSB
c           END DO
c         ELSE IF (INDEX(OUTFLOW,'RIGHT') > 0) THEN
c           FLOW_CF = ABS(FLOW/(FPSB-OUTPSB)/AVG_TRX)
c           OUTRATE = OUTRATE/FLOW_CF
c           OUTPSB = FPSB - OUTRATE/AVG_TRX
c           DO IZ = 1,NZ
c             FRAC_PS(IZ,NX+1) = OUTPSB
c           END DO
c         ELSE IF (INDEX(OUTFLOW,'TOP') > 0) THEN
c           FLOW_CF = ABS(FLOW/(FPSB-OUTPSB)/AVG_TRZ)
c           OUTRATE = OUTRATE/FLOW_CF
c           OUTPSB = FPSB - OUTRATE/AVG_TRZ
c           DO IX = 1,NX
c             FRAC_PS(NZ+1,IX) = OUTPSB
c           END DO
c         ELSE IF (INDEX(OUTFLOW,'BOTTOM') > 0) THEN
c           FLOW_CF = ABS(FLOW/(FPSB-OUTPSB)/AVG_TRZ)
c           OUTRATE = OUTRATE/FLOW_CF
c           OUTPSB = FPSB - OUTRATE/AVG_TRZ
c           DO IX = 1,NX
c             FRAC_PS(0,IX) = OUTPSB
c           END DO
c         ELSE
c           GOTO 1000
c         END IF
c C
c C       LOGGING CORRECTION FACTOR AND MAXIMUM RESIDUAL TO SCREEN
c         WRITE(CVAR,620)FLOW_CF
c         CALL MESSAGE(CVAR)
c         WRITE(CVAR,640)Q(5,MAXLOC(ABS(Q(5,:))))
c         CALL MESSAGE(CVAR)
c C
c C       COVERTING PSUEDO-PRESSURE TO REAL PRESSURE IF FLUID IS GAS
c         OUTPB = OUTPSB
c         IF (IFLUID == 1) CALL PS_TO_PR(OUTPB,OUTPSB,BOK)
c         IF (.NOT. BOK) GOTO 1000
c C
c       END IF
c==============================================================================
C
C     SOLVING FOR FLOW THROUGH FRACTURE
      CALL FRAC_FLOW(BOK)
      IF (.NOT. BOK) GOTO 1000
      CALL BLANK
      CALL MESSAGE("     FINAL FRACTURE FLOWS CALCULATED")
C
C     CALCULATING AND WRITTING OUTPUT DATA
      CALL OUTPUT_DATA
C
C     CLOSING OUTPUT FILES
      CLOSE(ISTAT)
      CLOSE(IMAP)
      CLOSE(IFLOX)
      CLOSE(IFLOZ)
      CLOSE(IFLOM)
      CLOSE(IPRES)
      CLOSE(IVTK)
C
      CALL BLANK
      CALL MESSAGE(" OUTPUT FILES CLOSED")
      CLOSE(IOUT)
C
      STOP
C
  600 FORMAT(5X,A,' BOUNDARY PRESSURE: ',3X,G20.9,1X,A)
C
  605 FORMAT(5X,A,' FLOW RATE CALCULATED: ',G20.9,1X,A)
C
  620 FORMAT(5X,'FLOW CORRECTION FACTOR USED: ',F13.9,1X,A)
C
  640 FORMAT(5X,'MAXIMUM NET FLOW RESIDUAL: ',G20.9,1X,A)
C
 1000 WRITE(*,"(1X)")
      WRITE(*,"('     **** EXITING PROGRAM ****')")
      STOP(1)
C
      END PROGRAM
