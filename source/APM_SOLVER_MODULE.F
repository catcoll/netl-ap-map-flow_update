      MODULE APM_SOLVER_MODULE
C
C     WRITTEN BY: MATTHEW STADELMAN
C     FILE DESCRIPTION: STORES THE VARIABLES USED TO SOLVE THE
C         LINEAR SYSTEM OF EQUATIONS GENERATED BY THE LCL MODEL.
C
C     LAST MODIFIED: 2016/07/12
C ----------------------------------------------------------------------
C               ---- VARIABLE DESCRIPTIONS ----
C    COEFFICENT ARRAYS
C      CC - STORES THE VALUES ALONG THE MAIN DIAGONAL
C      TT - STORES THE OFF DIAGONAL TERMS FOR EACH ROW
C      RHS - STORES RHS VALUES FOR EACH ROW
C      X - STORES THE FINAL SOLUTIONS TO THE LINEAR SYSTEM
C      NEUMANNG_COL, NUEMANNG_ROW - STORES CONNECTION VALUES TO THE GROUP NODE
C      NEUMANN_CC - STORES THE MAIN DIAGONAL COMPONENT OF THE GROUP NODE ROW
C      NEUMANN_RHS, NEUMANN_X, - STORES THE RIGHT HAND SIDE AND SOLUTION VALUE
C
C    WORK ARRAYS
C      UPPER_D4 - STORES THE UPPER TRIANGLE OF THE LINEAR SYSTEM DURING ELIMINATION
C
C    INDEXING ARRAYS
C      LINK_D4 - STORES THE LEXOGRAPHICAL INDEX OF A VALUE IN D4 ORDER
C      INAT - COVERTS A D4 INDEX TO A LEXOGRAPHICAL INDEX
C      INO - CONVERTS A LEXOGRAPHICAL INDEX TO A D4 INDEX
C      IBASE_UPPER - USED TO ACCESS UPPER TRIANGLE VALUES FOR A SPECIFIC ROW
C
C    DATA EXTENTS
C      SOLV_NX - THE X-AXIS EXTENT OF THE SOLVER ARRAY AFTER BCs ARE ADDED
C      SOLV_NZ - THE Z-AXIS EXTENT OF THE SOLVER ARRAY AFTER BCs ARE ADDED
C      X_OFFSET - THE STARTING X-AXIS INDEX OF THE FIRST NON-BC CELL
C      Z_OFFSET - THE STARTING Z-AXIS INDEX OF THE FIRST NON-BC CELL
C      NUM_TOP - NUMBER OF ROWS IN THE TOP HALF OF LINEAR SYSTEM
C      NUM_BOTTOM - NUMBER OF ROWS IN THE LOWER HALF OF THE LINEAR SYSTEM
C      NUM_TOTAL - TOTAL NUMBER OF ROWS IN THE SYSTEM
C      MAX_BAND - THE MAXIMUM OFF DIAGONIAL INDEX IN THE LINEAR SYSTEM
C
C ----------------------------------------------------------------------
C
      PUBLIC
C
C     COEFFICENT ARRAYS
      REAL(8),ALLOCATABLE,SAVE :: CC(:),TT(:,:),RHS(:),X(:)
      REAL(8),ALLOCATABLE,SAVE :: NEUMANNG_ROW(:),NEUMANNG_COL(:)
      REAL(8),SAVE :: NEUMANNG_CC,NEUMANNG_RHS,NEUMANNG_X
C
C     WORK ARRAYS
      REAL(8),ALLOCATABLE,SAVE :: UPPER_D4(:)
C
C     INDEXING ARRAYS
      INTEGER,ALLOCATABLE,SAVE :: LINK_D4(:,:)
      INTEGER,ALLOCATABLE,SAVE :: INAT(:),INO(:)
      INTEGER,ALLOCATABLE,SAVE :: IBASE_UPPER(:)
C
C     DATA EXTENTS
      INTEGER,SAVE :: SOLV_NX,SOLV_NZ,X_OFFSET,Z_OFFSET
      INTEGER,SAVE :: NUM_TOP,NUM_BOTTOM,NUM_TOTAL,MAX_BAND
C
      CONTAINS
C
C     ALLOCATES THE SOLVER'S COEFFICIENT ARRAYS
      SUBROUTINE ALLOCATE_COEF(NUM_BLK)
        IMPLICIT NONE
        INTEGER :: NUM_BLK
        !
        ALLOCATE (CC(NUM_BLK), TT(NUM_BLK,4), RHS(NUM_BLK), X(NUM_BLK))
        !
        RETURN
      END SUBROUTINE
C
C     DEALLOCATES THE SOLVER'S COEFFICIENT ARRAYS
      SUBROUTINE DEALLOCATE_COEF
        IMPLICIT NONE
        !
        DEALLOCATE(CC, TT, RHS, X)
        DEALLOCATE(UPPER_D4, LINK_D4, INO, INAT, IBASE_UPPER)
        !
        RETURN
      END SUBROUTINE
C
      END MODULE