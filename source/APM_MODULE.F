      MODULE APM_MODULE
C
C     WRITTEN BY: MATTHEW STADELMAN
C     FILE DESCRIPTION: STORES THE NEEDED VARIABLES AND CONSTANTS FOR
C     2-D LOCAL CUBIC LAW MODEL.
C
C     LAST MODIFIED: 2016/06/27
C ----------------------------------------------------------------------
C               ---- VARIABLE DESCRIPTIONS ----
C
C   LNPROC PARAMETERS
C     MAXFLD,MAXLEN - MAXIMUM NUMBER OF FIELDS A LINE AND HAVE, MAXIMUM LENGTH OF A CHARACTER VARIABLE IN THE PROGRAM
C     LFLD - STORES THE LENGTH OF EACH CHARACTER STRING IN CFLD
C     CVAR - GENERAL USE CHARACTER VARIABLE USED TO WRITE MESSAGES TO THE SCREEN AND READ INPUT
C     CFLD - STORES THE STRING IN EACH FIELD
C
C   INTERPOLATION/PVT VARIABLES:
C     STD_PRES, STD_TEMP - STANDARD VALUES FOR TEMPERATURE AND PRESSURE USED TO CONVERT FROM RESERVOIR UNITS TO SURFACE UNITS
C     TEMP - FRACTURE TEMPERATURE
C     AVG_VISC - AVERAGE VISCOSITY OF THE FRACTURE USED IN LIQUID SIMULATIONS
C     RHO - USER SUPPLIED DENSITY OF THE FLUID, ONLY USED TO CALCULATE REYNOLDS NUMBER
C     PR, ZF, VI - VECTORS OF PRESSURE, Z FACTOR AND VISCOSITY FROM PVT FILE
C     PS, SQPS - VECTORS OF THE PSEUDO-PRESSURE AND ITS SQUAREROOT CALCULATED BASED ON PVT DATA
C     EQSPS - CONTAINS EQUALLY SPACED SQRT OF PSEUDO-PRESSURE VALUES
C     EQPR - CONTAINS THE CORRESPONDING PRESSURE VALUES TO EQSPS
C     DPR,DSPS - CHANGE IN PRESSURE AND CHANGE IN SQRT OF PSEUDO-PRESSURE
C     NVALS - NUMBER OF ENTRIES IN THE PVT DATA TABLE
C     VALS - NUMBER VALUES FROM 0 TO THE MAXIMUM VALUE IN PVT TABLE STORED IN THE PVT VECTORS
C     PRES_CONV,DIM_CONV,TIME_CONV,RATE_CONV,VISC_CONV,RHO_CONV,STD_CONV - STORES THE RESPECTIVE UNIT CONVERSION FOR EACH UNIT TYPE
C     UNIT(7),UNIT_IN(7),UNIT_OUT(7) - ARRAYS TO STORE THE RESPECTIVE STRING REPRESENTATION OF A UNIT TYPE
C
C   STATISTICS VARIABLES:
C     PERC_ARR - STORES THE USER INPUT PERCENTILE VALUES TO OUTPUT
C     MIN_APER,MAX_APER,AVG_APER,APER_RMS,APER_DEV - BULK FRACTURE APERTURE PROPERTIES, MIN,MAX,AVERAGE,RMS AND STANDARD DEVIATION
C     X_CORR,Z_CORR - APERTURE VARIATION CORRELATION LENGTHS HORIZONTAL AND VERTICAL RESPECTIVELY
C     FLOW_CF - REPRESENTS THE DISCREPANCY BETWEEN CUBIC LAW AND LOCAL CUBIC LAW (Q LCL)/(Q CL)
C     NPCT - THE NUMBER OF PERCENTILES IN THE PERC_ARRY
C     PERCENTILE - BOOLEAN TO OUTPUT PERCENTILES OR NOT DURING RUNTIME
C
C   FRACTURE VARIABLES:
C     AP_MAP - THE 2-D ARRAY THAT STORES THE APERTURE MAP PROVIDED BY THE USER
C     WIDTH - A VECTOR RESPRESENTATION OF THE APERTURE MAP AFTER MASKING AND ROUGHNESS HAVE BEEN APPLIED
C     DX,DZ - UNIFORMLY DEFINED TO BE 1 VOXEL, STORED AS AN ARRAY TO ALLOW BASIC GRID REFINEMENT IN THE FUTURE
C     FRAC_PR,FRAC_PS - FRACTURE PRESSURE AND PSEDUO-PRESSURE ARRAYS RESPECTIVELY
C     TRX,TRZ - HORIZONTAL AND VERTICAL GRID BLOCK TRANSMISSIBLITY ARRAYS, DEFINED AT LEFT AND TOP FACES OF A GRIDBLOCK RESPECTIVELY.
C     DIAM,LENG - PHYSICAL DIMENSIONS OF FRACTURE, DEFINED BY MAP DIMENSIONS (NX,NZ) AND USER SUPPLIED (VOXEL SIZE * MAP AVERAGING FACTOR)
C     AVG_TRX,AVG_TRZ - SIMPLE AVERAGES OF THE FRACTURE'S HORIZONTAL AND VERTICAL TRANSSMISSIBILTY.
C     FPB,FPSB - THE INITAL/INLET FRACTURE PRESSURE AND PSEDUO-PRESSURE
C     OUTFLOW - STORES WHAT SIDE OF THE FRACTURE IS OPEN TO FLUID FLOWING OUT OF IT, OPPOSITE SIDE IS THE INLET BOUNDARY, OTHER 2 SIDES ARE NO-FLOW BOUNARIES
C     OUTPB,OUTPSB - THE FACTURE'S OUTLET PRESSURE AND PESDUO-PRESSURE
C     OUTRATE - STORES THE FRACTURE OUTLET FLOW RATE, USED TO CALCULATE OUTPSB IF FRACTURE IS FLOW RATE CONTROLLED
C     RATEC,PRESC - BOOLEANS STATING IF THE FRACTURE IS CONTROLLED WITH A FLOW RATE OR PRESSURE BOUNDARY CONDITION
C     R_FACT - USER SUPPLIED ROUGHNESS REDUCTION (IN VOXELS), ACTS AS A BLANKET REDUCTION OF ALL GRIDBLOCK APERTURES
C     AVG_FACT - THE MAP'S HORIZONTAL AND VERTICAL AVERAGING FACTOR, NOT APPLIED TO APERTURE VALUES
C     LOW_MASK,HIGH_MASK - THE MINIMUM AND MAXIMUM APERTURE VALUES (IN VOXELS) TO BE ALLOWED IN THE MODEL, OFFENDING CELLS ARE INCREASING OR REDUCED ACCORDINGLY
C     OUTLET - STORES THE INDICIES OF GRIDBLOCKS AT THE OUTLET FACE
C     NC - STORES THE NUMBER OF OUTLET FACES
C     MAXDIM - THE MAXIMUM NUMBER OF GRIDBLOCKS ALONG ONE AXIS, VALUES CLOSE TO THE INPUT MAP'S MAXIMUM DIMENSION REDUCE EXCESS MEMORY USAGE
C     NX,NZ - THE APERTURE MAPS DIMENSIONS IN THE HORIZONTAL AND VERTICAL DIRECTIONS RESPECTIVELY
C     IFLUID - THE FLUID TYPE (1 - GAS, 2 - LIQUID)
C     MANIFOLD - BOOLEAN TO TELL THE PROGRAM TO ADD A UNIFORM MANIFOLD TO THE OUTLET OF THE FRACTURE
C     SOLVER_TYPE - STORES THE REQUESTED SOLVER TYPE TO USE (ONLY GAUSS IS FUNCTIONAL)
C
C   IO VARIABLES
C     SYS_OS - STORES THE TYPE OF THE SYSTEM, EITHER WINDOWS OR POSIX TO DETERMINE WHETHER TO USE / OR \
C     IINP,IPVT,IAPM - UNIT NUMBERS OF INPUT FILES : INITIALIZATION FILE, PVT DATA AND THE APERTURE MAP
C     IOUT,ISTAT,IPRES - UNIT NUMBERS OF OUTPUT FILES: RUNTIME SUMMARY, FRACTURE STATISTICS AND PRESSURE MAP
C     IFLOX,IFLOZ,IFLOM - UNIT NUMBERS OF OUTPUT FILES: X-FLOW COMPONENT, Z-FLOW COMPONENET AND FLOW MAGNITUDE FLOW MAPS
C     IMAP,IVTK,IBMD - UNIT NUMBERS OF OUTPUT FILES: APERTURE MAP, LEGACY VTK EXPORT AND BLOCK MESH DICT
C     MASTER - STORES FILE NAME OF INITIALIZATION FILE, DEFAULTS TO FRACTURE_INITIALIZATION UNLESS A NAME IS SUPPLIED ON THE COMMAND LINE
C     APM_FILE,PVT_FILE - STORE FILE NAMES OF APERTURE MAP AND PVT INPUT FILES
C     SUM_FILE,STAT_FILE,PRESS_FILE - STORES FILE NAMES OF OUTPUT FILES: RUNTIME SUMMARY, FACTURE STATISTICS AND PRESSURE MAP
C     FLOW_FILE - STORES THE ROOT NAME OF THE X,Z AND MAGNITUDE FLOW MAP FILES
C     MAP_FILE,VTK_FILE - STORES THE FILE NAMES OF THE OUTPUT APERTURE MAP AND LEGACY VTK FILE
C     BMD_FILE - STORES THE NAME OF THE BLOCK MESH DICT FILE
C
C   LCL MODEL VARIABLE DEFAULTS DEFINED IN SUBROUTINE:  INITIALIZE_RUN
C
C ---------------------------------------------------------------------
C
      PUBLIC
C
C     LNPROC PARAMETERS
      INTEGER :: MAXFLD,MAXLEN
      PARAMETER (MAXFLD = 100,MAXLEN = 256)
      !
      INTEGER,SAVE :: LFLD(MAXFLD)
      CHARACTER(MAXLEN),SAVE :: CVAR,CFLD(MAXFLD)
C
C     INTERPOLATION/PVT VARIABLES
      REAL(8),ALLOCATABLE,SAVE :: PR(:),ZF(:),VI(:),PS(:)
      REAL(8),ALLOCATABLE,SAVE :: SQPS(:),EQSPS(:),EQPR(:)
      REAL(8),SAVE :: DPR,DSPS
      REAL(8),SAVE :: AVG_VISC,TEMP,RHO,STD_TEMP,STD_PRES
      INTEGER, SAVE :: NVALS,VALS
C
C     UNIT CONVERSION VARIABLES
      ! VARIABLES TO STORE RESPECTIVE CONVERSION FACTORS
      REAL(8),SAVE :: PRES_CONV,DIM_CONV,TIME_CONV,RATE_CONV
      REAL(8),SAVE :: VISC_CONV,RHO_CONV,STD_CONV
      ! VARIABLES TO STORE THE STRING REPRESENTATION OF EACH UNIT
      CHARACTER(MAXLEN),SAVE :: UNIT(7),UNIT_IN(7),UNIT_OUT(7)
      ! STATICALLY DEFINED UNIT TO SI CONVERSIONS
      !TIME TO SECONDS
      REAL(8) :: DAY_SEC, HR_SEC, MIN_SEC
      PARAMETER (DAY_SEC = 86400.0, HR_SEC = 3600.0, MIN_SEC = 60.0)
      !DISTANCE TO METERS
      REAL(8) :: MIC_MET,MM_MET,CM_MET,IN_MET,FT_MET
      PARAMETER (MIC_MET = 1E-6, MM_MET = 1E-3, CM_MET = 0.01)
      PARAMETER (IN_MET = 0.0254, FT_MET = 0.3048)
      !MASS TO KILOGRAMS
      REAL(8) :: GM_KG,LBS_KG,SLG_KG
      PARAMETER (GM_KG = 0.001, LBS_KG = 0.4535924, SLG_KG = 14.59390)
      !PRESSURE TO PA
      REAL(8) :: ATM_PA, BAR_PA, KPA_PA, PSI_PA
      PARAMETER (ATM_PA = 101325.0, BAR_PA = 100000.0)
      PARAMETER (KPA_PA = 1000.0, PSI_PA = 6894.757293178)
      !TEMP TO RANKINE
      REAL(8) :: FAR_RAN
      PARAMETER (FAR_RAN = 459.67)
      !VISCOSITY TO PA*S
      REAL(8) :: CP_PASEC
      PARAMETER (CP_PASEC = 0.001)
      ! GRAVITY
      REAL(8) :: STD_G
      PARAMETER (STD_G = 9.80665)
C
C     STATISTICS VARIABLES
      REAL(8),ALLOCATABLE,SAVE :: PERC_ARR(:,:)
      REAL(8),SAVE :: MIN_APER,MAX_APER,APER_RMS,APER_DEV
      REAL(8),SAVE :: X_CORR,Z_CORR,FLOW_CF
      INTEGER,SAVE :: NPCT
      LOGICAL,SAVE :: PERCENTILE
C
C     FRACTURE VARAIBLES
      REAL(8),ALLOCATABLE,SAVE :: AP_MAP(:,:,:),WIDTH(:),DX(:),DZ(:)
      REAL(8),ALLOCATABLE,SAVE :: FRAC_PR(:,:),FRAC_PS(:,:)
      REAL(8),ALLOCATABLE,SAVE :: TRX(:,:),TRZ(:,:),Q(:,:)
      REAL(8),SAVE :: DIAM,LENG,AVG_APER,AVG_TRX,AVG_TRZ
      REAL(8),SAVE :: OUTPB,OUTPSB,OUTRATE,FPB,FPSB
      REAL(8),SAVE :: R_FACT,AVG_FACT,HIGH_MASK,LOW_MASK
      INTEGER,ALLOCATABLE,SAVE :: INLET(:), OUTLET(:)
      INTEGER,SAVE :: IFLUID,NX,NZ,NC,MAXDIM
      LOGICAL,SAVE :: MANIFOLD,RATEC,PRESC
      CHARACTER(MAXLEN),SAVE :: OUTFLOW,SOLVER_TYPE
C
C     D4 SOLVER VARIABLES
      ! COEFFICENT ARRAYS
      REAL(8),ALLOCATABLE,SAVE :: CC(:),TT(:,:)
      REAL(8),ALLOCATABLE,SAVE :: INLET_GROUP(:),OUTLET_GROUP(:)
      REAL(8),SAVE :: INLET_CC,INLET_RHS,INLET_X
      REAL(8),SAVE :: OUTLET_CC,OUTLET_RHS,OUTLET_X
      ! WORK ARRAYS
      REAL(8),ALLOCATABLE,SAVE :: UPPER_D4(:),ROW(:)
      ! INDEXING ARRAYS
      INTEGER,ALLOCATABLE,SAVE :: LINK_D4(:,:)
      INTEGER,ALLOCATABLE,SAVE :: INAT(:),INO(:)
      INTEGER,ALLOCATABLE,SAVE :: IBASE_UPPER(:)
      ! COEFFICENT DATA EXTENTS
      INTEGER,SAVE :: IBR_MAX(2)
      INTEGER,SAVE :: NUM_TOP,NUM_BOTTOM,NUM_TOTAL,MAX_BAND
C
C     IO VARIABLES
      !INPUT IO UNIT NUMBERS
      INTEGER,SAVE :: IINP,IPVT,IAPM
      !OUTPUT IO UNIT NUMBERS
      INTEGER,SAVE :: IOUT,ISTAT,IPRES,IFLOX,IFLOZ,IFLOM
      INTEGER,SAVE :: IMAP,IVTK
      CHARACTER(10),SAVE :: SYS_OS
      !INPUT FILE NAMES
      CHARACTER(MAXLEN),SAVE :: MASTER,APM_FILE,PVT_FILE
      ! OUTPUT FILE NAMES
      CHARACTER(MAXLEN),SAVE :: SUM_FILE,STAT_FILE,FLOW_FILE,PRESS_FILE
      CHARACTER(MAXLEN),SAVE :: MAP_FILE,VTK_FILE
C
C
      CONTAINS
C
C     SETS UP VECTORS AND ARRAYS FOR THE FRACTURE PROPERTIES
      SUBROUTINE ALLOCATE_FRAC(NX,NZ)
C
        IMPLICIT NONE
        INTEGER :: N, NX, NZ
        N = 5
        !
        ALLOCATE(WIDTH(NX*NZ),Q(N,NX*NZ))
        ALLOCATE(TRX(1:NZ,0:NX),TRZ(0:NZ,1:NX))
        ALLOCATE(INLET(MAX(NX,NZ)),OUTLET(MAX(NX,NZ)))
        ALLOCATE(FRAC_PR(0:NZ+1,0:NX+1),FRAC_PS(0:NZ+1,0:NX+1))
        ALLOCATE(DX(NX*NZ),DZ(NX*NZ))
        !
        RETURN
      END SUBROUTINE
C
C     ALLOCATES THE SOLVER'S COEFFICIENT ARRAYS
      SUBROUTINE ALLOCATE_COEF(NUM_BLK)
        IMPLICIT NONE
        INTEGER :: NUM_BLK
        !
        ALLOCATE (CC(NUM_BLK),TT(NUM_BLK,4))
        ALLOCATE (INLET_GROUP(NUM_BLK),OUTLET_GROUP(NUM_BLK))
        !
        RETURN
      END SUBROUTINE
C
C     DEALLOCATES THE SOLVER'S COEFFICIENT ARRAYS
      SUBROUTINE DEALLOCATE_COEF
        IMPLICIT NONE
        !
        DEALLOCATE (CC,TT,UPPER_D4,ROW,LINK_D4,INAT,IBASE_UPPER)
        DEALLOCATE (INLET_GROUP,OUTLET_GROUP)
        !
        RETURN
      END SUBROUTINE
C
      END MODULE




