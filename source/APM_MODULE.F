      MODULE APM_MODULE
C
C     WRITTEN BY: MATTHEW STADELMAN
C     FILE DESCRIPTION: STORES THE NEEDED VARIABLES AND CONSTANTS FOR
C     2-D LOCAL CUBIC LAW MODEL.
C
C     LAST MODIFIED: 2016/07/12
C ----------------------------------------------------------------------
C               ---- VARIABLE DESCRIPTIONS ----
C
C   UNIT CONVERSION VARIABLES
C     PRES_CONV,DIM_CONV,TIME_CONV, ...
C     RATE_CONV,VISC_CONV,RHO_CONV - STORES THE RESPECTIVE UNIT CONVERSION FOR EACH UNIT TYPE
C     UNIT(7),UNIT_IN(7),UNIT_OUT(7) - ARRAYS TO STORE THE RESPECTIVE STRING REPRESENTATION OF A UNIT TYPE
C
C   STATISTICS VARIABLES:
C     PERC_ARR - STORES THE USER INPUT PERCENTILE VALUES TO OUTPUT
C     MIN_APER,MAX_APER,AVG_APER,APER_RMS,APER_DEV - BULK FRACTURE APERTURE PROPERTIES, MIN,MAX,AVERAGE,RMS AND STANDARD DEVIATION
C     X_CORR,Z_CORR - APERTURE VARIATION CORRELATION LENGTHS HORIZONTAL AND VERTICAL RESPECTIVELY
C     FLOW_CF - REPRESENTS THE DISCREPANCY BETWEEN CUBIC LAW AND LOCAL CUBIC LAW (Q LCL)/(Q CL)
C     NPCT - THE NUMBER OF PERCENTILES IN THE PERC_ARRY
C     PERCENTILE - BOOLEAN TO OUTPUT PERCENTILES OR NOT DURING RUNTIME
C
C   FRACTURE VARIABLES:
C     AP_MAP - THE 2-D ARRAY THAT STORES THE APERTURE MAP PROVIDED BY THE USER
C     WIDTH - A VECTOR RESPRESENTATION OF THE APERTURE MAP AFTER MASKING AND ROUGHNESS HAVE BEEN APPLIED
C     DX,DZ - UNIFORMLY DEFINED TO BE 1 VOXEL, STORED AS AN ARRAY TO ALLOW BASIC GRID REFINEMENT IN THE FUTURE
C     FRAC_PR,FRAC_PS - FRACTURE PRESSURE AND PSEDUO-PRESSURE ARRAYS RESPECTIVELY
C     TRX,TRZ - HORIZONTAL AND VERTICAL GRID BLOCK TRANSMISSIBLITY ARRAYS, DEFINED AT LEFT AND TOP FACES OF A GRIDBLOCK RESPECTIVELY.
C     DIAM,LENG - PHYSICAL DIMENSIONS OF FRACTURE, DEFINED BY MAP DIMENSIONS (NX,NZ) AND USER SUPPLIED (VOXEL SIZE * MAP AVERAGING FACTOR)
C     AVG_TRX,AVG_TRZ - SIMPLE AVERAGES OF THE FRACTURE'S HORIZONTAL AND VERTICAL TRANSSMISSIBILTY.
C     AVG_VISC - AVERAGE VISCOSITY OF THE FRACTURE USED IN LIQUID SIMULATIONS
C     RHO - USER SUPPLIED DENSITY OF THE FLUID, ONLY USED TO CALCULATE REYNOLDS NUMBER
C     FPB,FPSB - THE INITAL/INLET FRACTURE PRESSURE AND PSEDUO-PRESSURE
C     OUTFLOW - STORES WHAT SIDE OF THE FRACTURE IS OPEN TO FLUID FLOWING OUT OF IT, OPPOSITE SIDE IS THE INLET BOUNDARY, OTHER 2 SIDES ARE NO-FLOW BOUNARIES
C     OUTPB,OUTPSB - THE FACTURE'S OUTLET PRESSURE AND PESDUO-PRESSURE
C     OUTRATE - STORES THE FRACTURE OUTLET FLOW RATE, USED TO CALCULATE OUTPSB IF FRACTURE IS FLOW RATE CONTROLLED
C     RATEC,PRESC - BOOLEANS STATING IF THE FRACTURE IS CONTROLLED WITH A FLOW RATE OR PRESSURE BOUNDARY CONDITION
C     R_FACT - USER SUPPLIED ROUGHNESS REDUCTION (IN VOXELS), ACTS AS A BLANKET REDUCTION OF ALL GRIDBLOCK APERTURES
C     AVG_FACT - THE MAP'S HORIZONTAL AND VERTICAL AVERAGING FACTOR, NOT APPLIED TO APERTURE VALUES
C     LOW_MASK,HIGH_MASK - THE MINIMUM AND MAXIMUM APERTURE VALUES (IN VOXELS) TO BE ALLOWED IN THE MODEL, OFFENDING CELLS ARE INCREASING OR REDUCED ACCORDINGLY
C     OUTLET - STORES THE INDICIES OF GRIDBLOCKS AT THE OUTLET FACE
C     NC - STORES THE NUMBER OF OUTLET FACES
C     MAXDIM - THE MAXIMUM NUMBER OF GRIDBLOCKS ALONG ONE AXIS, VALUES CLOSE TO THE INPUT MAP'S MAXIMUM DIMENSION REDUCE EXCESS MEMORY USAGE
C     NX,NZ - THE APERTURE MAPS DIMENSIONS IN THE HORIZONTAL AND VERTICAL DIRECTIONS RESPECTIVELY
C     IFLUID - THE FLUID TYPE (1 - GAS, 2 - LIQUID)
C     MANIFOLD - BOOLEAN TO TELL THE PROGRAM TO ADD A UNIFORM MANIFOLD TO THE OUTLET OF THE FRACTURE
C
C   IO VARIABLES
C     SYS_OS - STORES THE TYPE OF THE SYSTEM, EITHER WINDOWS OR POSIX
C     CVAR - GENERAL USE CHARACTER VARIABLE USED TO WRITE MESSAGES TO THE SCREEN AND READ INPUT
C     IINP,IPVT,IAPM - UNIT NUMBERS OF INPUT FILES : INITIALIZATION FILE, PVT DATA AND THE APERTURE MAP
C     IOUT,ISTAT,IPRES - UNIT NUMBERS OF OUTPUT FILES: RUNTIME SUMMARY, FRACTURE STATISTICS AND PRESSURE MAP
C     IFLOX,IFLOZ,IFLOM - UNIT NUMBERS OF OUTPUT FILES: X-FLOW COMPONENT, Z-FLOW COMPONENET AND FLOW MAGNITUDE FLOW MAPS
C     IMAP,IVTK,IBMD - UNIT NUMBERS OF OUTPUT FILES: APERTURE MAP, LEGACY VTK EXPORT AND BLOCK MESH DICT
C     MASTER - STORES FILE NAME OF INITIALIZATION FILE, DEFAULTS TO FRACTURE_INITIALIZATION UNLESS A NAME IS SUPPLIED ON THE COMMAND LINE
C     APM_FILE,PVT_FILE - STORE FILE NAMES OF APERTURE MAP AND PVT INPUT FILES
C     SUM_FILE,STAT_FILE,PRESS_FILE - STORES FILE NAMES OF OUTPUT FILES: RUNTIME SUMMARY, FACTURE STATISTICS AND PRESSURE MAP
C     FLOW_FILE - STORES THE ROOT NAME OF THE X,Z AND MAGNITUDE FLOW MAP FILES
C     MAP_FILE,VTK_FILE - STORES THE FILE NAMES OF THE OUTPUT APERTURE MAP AND LEGACY VTK FILE
C     BMD_FILE - STORES THE NAME OF THE BLOCK MESH DICT FILE
C
C   LCL MODEL VARIABLE DEFAULTS DEFINED IN SUBROUTINE: INITIALIZE_RUN
C
C ---------------------------------------------------------------------
C
      USE STRING_MODULE, ONLY : MAXLEN
      PUBLIC
C
C     UNIT CONVERSION VARIABLES
      ! VARIABLES TO STORE RESPECTIVE CONVERSION FACTORS
      REAL(8),SAVE :: PRES_CONV,DIM_CONV,TIME_CONV,RATE_CONV
      REAL(8),SAVE :: VISC_CONV,RHO_CONV
      ! VARIABLES TO STORE THE STRING REPRESENTATION OF EACH UNIT
      CHARACTER(MAXLEN),SAVE :: UNIT(7),UNIT_IN(7),UNIT_OUT(7)
C
C     STATISTICS VARIABLES
      REAL(8),ALLOCATABLE,SAVE :: PERC_ARR(:,:)
      REAL(8),SAVE :: MIN_APER,MAX_APER,APER_RMS,APER_DEV
      REAL(8),SAVE :: X_CORR,Z_CORR,FLOW_CF
      INTEGER,SAVE :: NPCT
      LOGICAL,SAVE :: PERCENTILE
C
C     FRACTURE VARAIBLES
      REAL(8),ALLOCATABLE,SAVE :: AP_MAP(:,:,:),WIDTH(:),DX(:),DZ(:)
      REAL(8),ALLOCATABLE,SAVE :: FRAC_PR(:,:),FRAC_PS(:,:)
      REAL(8),ALLOCATABLE,SAVE :: TRX(:,:),TRZ(:,:),Q(:,:)
      REAL(8),SAVE :: DIAM,LENG,AVG_APER,AVG_TRX,AVG_TRZ,AVG_VISC
      REAL(8),SAVE :: FPB,FPSB,OUTPB,OUTPSB,OUTRATE,INJRATE,RHO
      REAL(8),SAVE :: R_FACT,AVG_FACT,HIGH_MASK,LOW_MASK
      INTEGER,ALLOCATABLE,SAVE :: INLET(:), OUTLET(:)
      INTEGER,SAVE :: IFLUID,NX,NZ,NC,MAXDIM
      LOGICAL,SAVE :: MANIFOLD,RATEC,PRESC
      CHARACTER(MAXLEN),SAVE :: OUTFLOW,INLET_SIDE
C
C     IO VARIABLES
      !INPUT IO UNIT NUMBERS
      INTEGER,SAVE :: IINP,IPVT,IAPM
      !OUTPUT IO UNIT NUMBERS
      INTEGER,SAVE :: IOUT,ISTAT,IPRES,IFLOX,IFLOZ,IFLOM
      INTEGER,SAVE :: IMAP,IVTK
      CHARACTER(10),SAVE :: SYS_OS
      CHARACTER(MAXLEN),SAVE :: CVAR
      !INPUT FILE NAMES
      CHARACTER(MAXLEN),SAVE :: MASTER,APM_FILE,PVT_FILE
      ! OUTPUT FILE NAMES
      CHARACTER(MAXLEN),SAVE :: SUM_FILE,STAT_FILE,FLOW_FILE,PRESS_FILE
      CHARACTER(MAXLEN),SAVE :: MAP_FILE,VTK_FILE
C
C
      CONTAINS
C
C     SETS UP VECTORS AND ARRAYS FOR THE FRACTURE PROPERTIES
      SUBROUTINE ALLOCATE_FRAC(NX,NZ)
C
        IMPLICIT NONE
        INTEGER :: N, NX, NZ
        N = 5
        !
        ALLOCATE(WIDTH(NX*NZ),Q(N,NX*NZ))
        ALLOCATE(TRX(1:NZ,0:NX),TRZ(0:NZ,1:NX))
        ALLOCATE(INLET(MAX(NX,NZ)),OUTLET(MAX(NX,NZ)))
        ALLOCATE(FRAC_PR(0:NZ+1,0:NX+1),FRAC_PS(0:NZ+1,0:NX+1))
        ALLOCATE(DX(NX*NZ),DZ(NX*NZ))
        !
        RETURN
      END SUBROUTINE
C
      SUBROUTINE DEALLOCATE_FRAC
        !
        DEALLOCATE(AP_MAP,WIDTH,DX,DZ,TRX,TRZ)
        DEALLOCATE(Q,INLET,OUTLET,PERC_ARR)
        DEALLOCATE(FRAC_PR,FRAC_PS)
        !
        RETURN
      END SUBROUTINE
C
      END MODULE




